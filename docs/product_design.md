# AIVim - Rust实现的Vim编辑器

## 产品设计文档

> 版本: 0.1.0  
> 日期: 2026-02-19  
> 目标: 使用Rust从零构建一个功能完整、高性能的Vim兼容编辑器

---

## 1. 产品概述

### 1.1 项目目标

AIVim是一个使用Rust语言实现的Vim兼容文本编辑器，旨在：
- 提供与Vim高度兼容的编辑体验
- 利用Rust的安全性和性能优势
- 支持现代终端特性（真彩色、Unicode、鼠标等）
- 实现可扩展的插件架构

### 1.2 核心设计理念

1. **兼容性优先**: 尽可能兼容Vim的核心编辑模型和命令
2. **渐进式开发**: 从最小可用产品开始，逐步增加功能
3. **性能导向**: 利用Rust的零成本抽象，确保大文件编辑流畅
4. **现代体验**: 在保持Vim精神的同时，支持现代终端特性
5. **轻量优先**: 保持核心精简，**直接支持LSP，抛弃历史包袱**（不实现ctags/omni completion等旧式方案）

---

## 2. 功能分级体系

所有功能按照**必要性**和**实现难度**分为四个等级：

| 等级 | 名称 | 说明 |
|------|------|------|
| P0 | 核心功能 | 编辑器最小可用集，必须实现 |
| P1 | 基础功能 | 日常编辑必需，实现相对简单 |
| P2 | 高级功能 | 提升效率，实现较复杂 |
| P3 | 扩展功能 | 锦上添花，实现难度高 |

---

## 3. 功能模块详述

### 3.1 核心编辑引擎 (Core Engine)

#### P0 - 核心功能
- [ ] **缓冲区管理**: 基本的文本缓冲区，支持插入/删除字符
- [ ] **光标移动**: 基础移动 (h/j/k/l, w/b/e, 0/^/$, gg/G)
- [ ] **模式系统**: Normal/Insert/Visual三种基础模式
- [ ] **基本编辑**: 插入(i/a/o)、删除(x/dd)、替换(r)
- [ ] **撤销/重做**: 单步撤销/重做系统
- [ ] **文件IO**: 打开、保存、退出 (:w/:q/:wq)

#### P1 - 基础功能
- [ ] **高级移动**: 词移动(ge/gE)、屏幕移动(H/M/L)、段落移动({/})
- [ ] **文本对象**: aw/iw/as/is等文本对象操作
- [ ] **寄存器系统**: 无名寄存器、命名寄存器(a-z)、剪贴板寄存器(+/*)
- [ ] **宏录制**: q录制/@回放
- [ ] **多点撤销**: 撤销树(undotree)基础实现
- [ ] **搜索基础**: /?搜索、n/N跳转、基本正则

#### P2 - 高级功能
- [ ] **高级文本对象**: 函数对象(if/af)、标签对象(it/at)
- [ ] **标记系统**: 本地标记(a-z)、全局标记(A-Z)、跳转列表
- [ ] **高级搜索**: 增量搜索、高亮、替换(:s)、全局命令(:g)
- [ ] **多文件编辑**: 缓冲区列表、参数列表、窗口分割基础
- [ ] **代码折叠**: 手动折叠、语法折叠

#### P3 - 扩展功能
- [ ] **Diff模式**: 文件对比编辑
- [ ] **加密支持**: 文件加密保存/打开
- [ ] **二进制编辑**: 十六进制编辑模式
- [ ] **超大文件**: 内存映射、延迟加载

### 3.2 终端UI系统 (Terminal UI)

#### P0 - 核心功能
- [ ] **终端控制**: 使用crossterm进行原始模式控制
- [ ] **屏幕渲染**: 双缓冲渲染、脏矩形优化
- [ ] **状态栏**: 基础状态显示(模式、文件名、行号)
- [ ] **命令行**: 底部命令输入行
- [ ] **基本颜色**: 16色支持

#### P1 - 基础功能
- [ ] **真彩色支持**: 24位真彩色渲染
- [ ] **光标样式**: 不同模式下的光标形状变化
- [ ] **行号显示**: 绝对行号、相对行号
- [ ] **滚动优化**: 平滑滚动、屏幕外渲染优化
- [ ] **Unicode支持**: 宽字符、组合字符正确处理

#### P2 - 高级功能
- [ ] **弹出菜单**: 自动补全菜单、右键菜单
- [ ] **浮动窗口**: 悬浮提示、预览窗口
- [ ] **多窗口管理**: 分屏、标签页
- [ ] **终端集成**: 内置终端模拟器
- [ ] **图片显示**: 终端图片协议支持(iTerm/Sixel)

#### P3 - 扩展功能
- [ ] **GUI前端**: 可选的GUI界面(使用egui/iced)
- [ ] **远程UI**: 客户端-服务器架构
- [ ] **Web界面**: WebAssembly编译支持

### 3.3 配置与脚本系统 (Configuration)

#### P0 - 核心功能
- [ ] **基础配置**: 简单的键值对配置(set number等)
- [ ] **键位映射**: nmap/imap/vmap基础映射
- [ ] **配置文件**: 读取初始化脚本

#### P1 - 基础功能
- [ ] **条件配置**: if/else条件判断
- [ ] **自动命令**: autocmd事件系统
- [ ] **变量系统**: 全局变量(g:)、缓冲区变量(b:)
- [ ] **函数定义**: 用户自定义函数

#### P2 - 高级功能
- [ ] **VimScript解析器**: 完整的VimScript语法支持
- [ ] **Lua集成**: Lua作为首选脚本语言
- [ ] **配置热重载**: 运行时重新加载配置
- [ ] **配置验证**: 配置语法检查和错误提示

#### P3 - 扩展功能
- [ ] **Python集成**: Python脚本支持
- [ ] **JavaScript集成**: Deno/Node.js脚本支持
- [ ] **配置GUI**: 图形化配置界面

### 3.4 语法高亮与文件类型 (Syntax & FT)

#### P0 - 核心功能
- [ ] **基础高亮**: 关键字、字符串、注释高亮
- [ ] **文件类型检测**: 基于扩展名和内容的检测
- [ ] **配色方案**: 内置基础配色方案

#### P1 - 基础功能
- [ ] **Tree-sitter集成**: 现代语法解析
- [ ] **多语言支持**: 常见编程语言高亮
- [ ] **缩进检测**: 自动检测空格/Tab缩进
- [ ] **文件编码**: UTF-8/GBK等编码支持

#### P2 - 高级功能
- [ ] **语义高亮**: LSP驱动的语义着色
- [ ] **代码折叠**: 基于语法树的折叠
- [ ] **缩进指南**: 缩进线显示
- [ ] **彩虹括号**: 匹配括号着色

#### P3 - 扩展功能
- [ ] **实时预览**: Markdown等实时预览
- [ ] **代码格式化**: 集成formatters
- [ ] **自定义语法**: 用户自定义语法规则

### 3.5 LSP与代码智能 (LSP Integration) - 轻量核心策略

> **设计原则**: AIVim 采用轻量策略，**直接支持LSP，抛弃ctags/omni completion等历史包袱**。LSP是代码智能的唯一方案。

#### P2 - 核心功能（优先实现）
- [ ] **LSP客户端**: 基于 `tower-lsp` 或自研LSP客户端
- [ ] **诊断显示**: 错误/警告标记（行内高亮）
- [ ] **跳转定义**: `gd` 跳转定义
- [ ] **悬停提示**: `K` 显示文档
- [ ] **自动补全**: 基于LSP的代码补全（基础版）

#### P3 - 高级功能
- [ ] **代码动作**: 重命名、提取函数等
- [ ] **代码大纲**: 文件结构导航
- [ ] **引用查找**: `gr` 查找引用
- [ ] **调试集成**: DAP协议支持
- [ ] **AI辅助**: GitHub Copilot等集成

#### 明确不实现（历史包袱）
- ❌ **ctags 支持**: 使用LSP替代
- ❌ **Omni Completion**: 使用LSP替代
- ❌ **语法文件补全**: 使用LSP替代
- ❌ **YouCompleteMe兼容**: 使用原生LSP替代

### 3.6 插件系统 (Plugin System)

#### P2 - 高级功能
- [ ] **插件管理器**: 插件安装/更新/删除
- [ ] **插件API**: 稳定的Rust API接口
- [ ] **插件隔离**: 沙箱化插件执行

#### P3 - 扩展功能
- [ ] **插件市场**: 官方插件仓库
- [ ] **Vim插件兼容**: 加载Vim/Neovim插件
- [ ] **Web插件**: 基于WASM的插件

### 3.7 其他功能 (Miscellaneous)

#### P1 - 基础功能
- [ ] **会话管理**: 保存/恢复编辑会话
- [ ] **备份与恢复**: 自动备份、交换文件
- [ ] **外部命令**: !执行shell命令
- [ ] **快速修复**: quickfix列表

#### P2 - 高级功能
- [ ] **模糊查找**: 文件/符号模糊搜索
- [ ] **Git集成**: Gutter标记、 blame显示
- [ ] **项目管理**: 项目级配置和导航

#### P3 - 扩展功能
- [ ] **协作编辑**: 多人实时协作
- [ ] **云同步**: 配置跨设备同步
- [ ] **AI助手**: 内置AI对话界面

---

## 4. 分阶段开发路线图

### 阶段一: 最小可用产品 (MVP) - 预计4-6周

**目标**: 实现一个可以编辑文本的基础编辑器

**核心任务**:
1. 项目搭建与架构设计 (3天)
   - 项目结构初始化
   - 核心模块划分
   - CI/CD配置

2. 终端控制与渲染 (1周)
   - 集成crossterm
   - 实现原始模式控制
   - 基础屏幕渲染

3. 缓冲区与编辑引擎 (1.5周)
   - 实现Rope数据结构
   - 基础插入/删除操作
   - 文件读写

4. 模式系统 (1周)
   - Normal/Insert模式切换
   - 基础命令解析
   - 光标移动实现

5. 基础UI (1周)
   - 状态栏显示
   - 命令行输入
   - 错误提示

**阶段一验收标准**:
- [ ] 可以打开、编辑、保存文本文件
- [ ] 支持h/j/k/l光标移动
- [ ] 支持i/a进入插入模式，Esc返回Normal模式
- [ ] 支持:w/:q/:wq命令
- [ ] 支持u撤销

---

### 阶段二: 基础编辑体验 - 预计6-8周

**目标**: 实现日常编辑所需的基础功能

**核心任务**:
1. 高级光标移动 (1周)
   - 词移动(w/b/e/ge)
   - 行首/行尾移动(0/^/$)
   - 文档跳转(gg/G)

2. 高级编辑命令 (1.5周)
   - 删除操作(d/dd/D)
   - 复制粘贴(y/p)
   - 修改操作(c/cc/C)

3. 寄存器系统 (1周)
   - 无名寄存器
   - 命名寄存器
   - 剪贴板集成

4. 搜索功能 (1周)
   - /?搜索
   - n/N跳转
   - 基础正则支持

5. 文本对象 (1周)
   - aw/iw
   - as/is/ap/ip

6. 配置系统 (1.5周)
   - 基础set命令
   - 键位映射(nmap/imap)
   - 配置文件读取

**阶段二验收标准**:
- [ ] 支持所有基础Vim移动命令
- [ ] 支持完整的删除/复制/粘贴操作
- [ ] 支持多级撤销
- [ ] 支持基础搜索替换
- [ ] 可通过配置文件自定义键位

---

### 阶段三: 多文件与窗口 - 预计6-8周

**目标**: 支持多文件编辑和窗口管理

**核心任务**:
1. 缓冲区管理 (1.5周)
   - 多缓冲区支持
   - 缓冲区列表(:ls/:b)
   - 缓冲区切换

2. 窗口系统 (2周)
   - 窗口分割(:sp/:vsp)
   - 窗口导航(C-w hjkl)
   - 窗口大小调整

3. 标签页 (1周)
   - 标签页创建/关闭
   - 标签页导航
   - 标签页管理

4. 高级文件操作 (1.5周)
   - 参数列表(:args)
   - 文件浏览器基础
   - 最近文件记录

**阶段三验收标准**:
- [ ] 可同时打开多个文件
- [ ] 支持水平/垂直分屏
- [ ] 支持标签页
- [ ] 可在文件间快速切换

---

### 阶段四: 语法高亮与现代化 - 预计8-10周

**目标**: 实现现代化的编辑体验

**核心任务**:
1. Tree-sitter集成 (2周)
   - 集成tree-sitter库
   - 语法树解析
   - 增量解析支持

2. 语法高亮 (2周)
   - 基于Tree-sitter的高亮
   - 配色方案系统
   - 真彩色支持

3. 终端UI增强 (2周)
   - 行号显示(绝对/相对)
   - 光标样式切换
   - 弹出菜单支持

4. 文件类型支持 (2周)
   - 文件类型检测
   - 文件类型特定设置
   - 缩进规则

**阶段四验收标准**:
- [ ] 支持主流编程语言语法高亮
- [ ] 支持真彩色显示
- [ ] 支持相对行号
- [ ] 文件类型自动检测

---

### 阶段五: LSP与代码智能 - 预计8-10周

**目标**: 实现IDE级别的代码支持

**核心任务**:
1. LSP客户端 (3周)
   - LSP协议实现
   - 服务器管理
   - 消息处理

2. 诊断系统 (2周)
   - 错误/警告收集
   - 诊断显示
   - 快速修复

3. 代码导航 (2周)
   - 跳转到定义
   - 查找引用
   - 符号搜索

4. 自动补全 (2周)
   - 补全引擎
   - 补全UI
   - 片段支持

**阶段五验收标准**:
- [ ] 支持主流LSP服务器
- [ ] 实时显示代码错误
- [ ] 支持代码跳转
- [ ] 智能代码补全

---

### 阶段六: 高级功能与优化 - 预计持续迭代

**目标**: 完善功能，提升性能，构建生态

**核心任务**:
1. 性能优化
   - 大文件优化
   - 渲染优化
   - 启动时间优化

2. 插件系统
   - Lua脚本支持
   - 插件API设计
   - 插件管理器

3. 高级编辑功能
   - 宏录制回放
   - 标记系统
   - 折叠功能

4. 生态建设
   - 文档完善
   - 社区建设
   - 插件生态

---

## 5. 技术架构

### 5.1 项目结构

```
aivim/
├── Cargo.toml
├── crates/
│   ├── aivim-core/          # 核心编辑引擎
│   │   ├── src/
│   │   │   ├── buffer/      # 缓冲区管理
│   │   │   ├── editor/      # 编辑器状态
│   │   │   ├── motion/      # 光标移动
│   │   │   ├── edit/        # 编辑操作
│   │   │   └── undo/        # 撤销系统
│   │   └── Cargo.toml
│   │
│   ├── aivim-tui/           # 终端UI
│   │   ├── src/
│   │   │   ├── render/      # 渲染引擎
│   │   │   ├── ui/          # UI组件
│   │   │   ├── input/       # 输入处理
│   │   │   └── theme/       # 主题系统
│   │   └── Cargo.toml
│   │
│   ├── aivim-config/        # 配置系统
│   │   ├── src/
│   │   │   ├── parser/      # 配置解析
│   │   │   ├── mapping/     # 键位映射
│   │   │   └── option/      # 选项管理
│   │   └── Cargo.toml
│   │
│   ├── aivim-syntax/        # 语法高亮
│   │   ├── src/
│   │   │   ├── treesitter/  # Tree-sitter集成
│   │   │   ├── highlight/   # 高亮引擎
│   │   │   └── theme/       # 配色方案
│   │   └── Cargo.toml
│   │
│   ├── aivim-lsp/           # LSP客户端
│   │   ├── src/
│   │   │   ├── client/      # LSP客户端
│   │   │   ├── types/       # LSP类型
│   │   │   └── handlers/    # 消息处理器
│   │   └── Cargo.toml
│   │
│   └── aivim-plugin/        # 插件系统
│       ├── src/
│       │   ├── lua/         # Lua运行时
│       │   ├── api/         # 插件API
│       │   └── manager/     # 插件管理
│       └── Cargo.toml
│
├── src/
│   └── main.rs              # 程序入口
│
├── docs/
│   ├── architecture.md      # 架构文档
│   ├── api.md               # API文档
│   └── user_guide.md        # 用户指南
│
├── tests/
│   └── integration_tests/
│
└── config/
    └── default_config.toml  # 默认配置
```

### 5.2 核心数据结构

```rust
// 缓冲区 - 使用Rope实现高效文本操作
pub struct Buffer {
    id: BufferId,
    rope: Rope,
    file_path: Option<PathBuf>,
    encoding: Encoding,
    modified: bool,
    undo_history: UndoHistory,
}

// 编辑器状态
pub struct Editor {
    buffers: HashMap<BufferId, Buffer>,
    current_buffer: BufferId,
    mode: Mode,
    windows: Vec<Window>,
    current_window: WindowId,
    registers: HashMap<char, Register>,
    options: EditorOptions,
}

// 窗口
pub struct Window {
    id: WindowId,
    buffer: BufferId,
    cursor: Cursor,
    viewport: Viewport,
    options: WindowOptions,
}

// 光标
pub struct Cursor {
    line: usize,
    column: usize,
    preferred_column: Option<usize>,
}

// 模式
pub enum Mode {
    Normal,
    Insert,
    Visual,
    Command,
    Replace,
}
```

### 5.3 依赖策略

| 功能领域 | 推荐依赖 | 备选方案 |
|---------|---------|---------|
| 终端控制 | crossterm | termion |
| 文本数据结构 | ropey | xi-rope |
| 异步运行时 | tokio | async-std |
| 序列化 | serde | - |
| 配置解析 | toml | json5 |
| 语法解析 | tree-sitter | 自定义 |
| Lua集成 | mlua | rlua |
| 正则表达式 | regex | fancy-regex |
| 错误处理 | thiserror + anyhow | - |
| 日志 | tracing | log |

---

## 6. 质量保证

### 6.1 测试策略

- **单元测试**: 每个模块的独立测试
- **集成测试**: 端到端的编辑流程测试
- **兼容性测试**: 与Vim的行为对比测试
- **性能测试**: 大文件、长时间运行的压力测试

### 6.2 代码质量

- 使用 `clippy` 进行静态分析
- 使用 `rustfmt` 统一代码风格
- 使用 `cargo-audit` 检查安全漏洞
- 使用 `cargo-tarpaulin` 测量代码覆盖率

### 6.3 文档要求

- 所有公共API必须有文档注释
- 复杂算法必须有设计文档
- 用户文档必须包含示例

---

## 7. 风险与缓解

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 性能不达标 | 高 | 早期进行性能测试，使用合适的数据结构 |
| Vim兼容性差 | 高 | 建立兼容性测试套件，参考Neovim实现 |
| 开发周期过长 | 中 | 严格按阶段交付，及时裁剪功能 |
| 跨平台问题 | 中 | 使用跨平台库，CI覆盖多平台 |
| 内存安全bug | 低 | 利用Rust所有权系统，充分测试 |

---

## 8. 附录

### 8.1 参考资源

- [Vim文档](https://vimhelp.org/)
- [Neovim源码](https://github.com/neovim/neovim)
- [xi-editor设计文档](https://github.com/xi-editor/xi-editor/blob/master/docs/docs.md)
- [Helix编辑器](https://github.com/helix-editor/helix)

### 8.2 术语表

- **Rope**: 一种用于高效存储和编辑大文本的树形数据结构
- **LSP**: Language Server Protocol，语言服务器协议
- **Tree-sitter**: 增量解析库，用于语法高亮和代码分析
- **Viewport**: 视口，当前窗口可见的文本区域

---

*本文档将根据开发进度持续更新*
